variables:
  ORIG_ARTIFACTS: "$CI_PROJECT_DIR/build/**/libs/*.jar*"
  ARTIFACTS: "$CI_PROJECT_DIR/*.jar*"
  TEST_REPORTS: "$CI_PROJECT_DIR/*-TestReport.zip"

cache:
  key: "$CI_COMMIT_REF_NAME/$CI_COMMIT_SHA"
  untracked: true

before_script:
  - shopt -s globstar

stages:
- build
- test
- deploy

build:
  stage: build
  script:
  - ./gradlew --console=plain assemble -Psigning.keyId="$keyId" -Psigning.password="$password" -Psigning.secretKeyRingFile="$secretKeyRingFile"
  - cp $ORIG_ARTIFACTS .
  when: on_success
  artifacts:
    paths:
    - $ARTIFACTS

test:
  stage: test
  script:
  - ./gradlew --console=plain check
  when: on_success
  artifacts:
    paths:
    - $TEST_REPORTS

deploy:
  stage: deploy
  script:
  - ./gradlew --console=plain uploadArchives -Psigning.keyId="$keyId" -Psigning.password="$password" -Psigning.secretKeyRingFile="$secretKeyRingFile"
  when: always
  only:
  - tags
